import{_ as Y}from"./B8aq_QmG.js";import{q as G,z as J,A as L,h as Q,r as m,e as X,B as Z,c as u,a as o,k as p,f as _,s,t as f,m as T,b as v,d as b,j as ee,l as V,v as z,i as oe,w as se,C as te,n as E,o as l,D as ae}from"#entry";import{u as re}from"./DMoW-9xf.js";import{u as ne}from"./C4JpkZNp.js";import{r as $}from"./CVHiCNXI.js";import{r as y}from"./D3n69WmM.js";import{r as ie}from"./Bi0YyG7H.js";import{r as le}from"./B2LZCxKM.js";import{r as de}from"./DBrhDGOf.js";const ce=window.setInterval,ue={class:"min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8"},me={class:"max-w-md w-full space-y-8"},pe={class:"text-center"},ge={class:"mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-blue-100"},fe={class:"mt-6 text-3xl font-extrabold text-gray-900"},ve={class:"mt-2 text-sm text-gray-600"},be={class:"flex justify-center space-x-1 bg-gray-100 p-1 rounded-lg"},xe={key:0,class:"rounded-md bg-green-50 p-4"},we={class:"flex"},ye={class:"ml-3"},he={class:"mt-2 text-sm text-green-700"},ke={class:"mt-4"},_e={class:"-mx-2 -my-1.5 flex"},Ee=["disabled"],Ce={key:1,class:"rounded-md bg-red-50 p-4"},Se={class:"flex"},Ue={class:"ml-3"},Ae={class:"mt-2 text-sm text-red-700"},Me={class:"mt-1 relative"},Re=["disabled","placeholder"],Le={key:0,class:"absolute inset-y-0 right-0 pr-3 flex items-center"},Te={key:0},Ve={class:"mt-1 relative"},ze=["disabled"],$e={key:1,class:"rounded-md bg-blue-50 p-4"},je={class:"flex"},Ne={class:"ml-3"},Be={class:"mt-3"},Pe=["disabled"],qe={key:0,class:"absolute left-0 inset-y-0 flex items-center pl-3"},Ie={class:"text-center"},De={class:"flex items-center justify-center space-x-2 text-sm text-gray-500"},Oe={class:"mt-6"},Fe={class:"mt-6 text-center space-y-2"},He={class:"text-sm text-gray-600"},Ke={key:0,class:"text-xs text-gray-500 bg-gray-100 rounded-md p-3 text-left"},We={class:"pt-4 border-t border-gray-200"},Ye={class:"flex justify-center space-x-4 mb-2"},Ge=["disabled"],no=G({__name:"login",setup(Je){const j=re(),N=J(),B=ne(),{user:x,sendMagicLink:U,signInWithPassword:P,testConnection:q,verifyConfig:A,isSuperUser:I}=B;L(x,(t,e)=>{console.log("👀 Watcher del usuario activado:",{newUser:t?.email||"null",oldUser:e?.email||"null"}),t&&!e&&(console.log("✅ Usuario detectado por watcher, redirigiendo..."),E("/dashboard",{replace:!0}))},{immediate:!0});const r=Q({email:"",password:""}),i=m(!1),a=m(""),g=m(!1),h=m(!1),w=m(!1),k=m(0),n=m("magic-link"),C=m(!1),M=N.query.error;if(M)switch(M){case"invalid_session":a.value="El enlace ha expirado o es inválido. Solicita uno nuevo.";break;case"callback_error":a.value="Error en el proceso de autenticación. Inténtalo de nuevo.";break;default:a.value="Ha ocurrido un error. Inténtalo de nuevo."}const D=async()=>{if(!(!r.email||i.value)){if(n.value==="password"&&!r.password){a.value="Por favor ingresa la contraseña";return}i.value=!0,a.value="";try{const t=A();console.log("🔍 Verificación de URL:",t),console.log("🔧 Usando cliente forzado con URL:",t.url),console.log("🚀 Probando conexión con URL CORRECTA...");const e=await q();if(!e.success){console.error("❌ Fallo en test de conexión:",e.error),a.value=`Error de conexión: ${e.error}`;return}if(n.value==="magic-link"){console.log("✅ Conexión exitosa, enviando Magic Link...");const d=await U(r.email);if(!d.success){console.error("❌ Error al enviar Magic Link:",d.error),a.value=d.error;return}console.log("✅ Magic Link enviado exitosamente"),g.value=!0,R()}else{console.log("✅ Conexión exitosa, autenticando con contraseña...");const d=await P(r.email,r.password);if(!d.success){console.error("❌ Error de autenticación:",d.error),a.value=d.error;return}console.log("✅ Autenticación exitosa, forzando actualización del estado...");try{await j.auth.getSession(),await ae(),console.log("🔄 Estado del usuario después del login:",x.value?"Autenticado":"No autenticado"),x.value?(console.log("✅ Usuario confirmado, redirigiendo inmediatamente..."),await E("/dashboard",{replace:!0})):(console.log("⚠️ Usuario no detectado, esperando actualización automática..."),setTimeout(async()=>{console.log("🔄 Verificación tardía del usuario:",x.value?"Autenticado":"No autenticado"),x.value?(console.log("🔄 Redirección tardía..."),await E("/dashboard",{replace:!0})):(console.error("❌ El usuario no se actualizó correctamente"),window.location.href="/dashboard")},2e3))}catch(c){console.error("💥 Error actualizando estado:",c),setTimeout(()=>{window.location.href="/dashboard"},1e3)}}}catch(t){console.error("💥 Error capturado:",t),a.value=t.message||"Error en la autenticación"}finally{i.value=!1}}},O=async()=>{if(!(w.value||i.value)){i.value=!0,a.value="";try{console.log("🔄 Reenviando Magic Link con URL CORRECTA...");const t=await U(r.email);if(!t.success){console.error("❌ Error al reenviar:",t.error),a.value=t.error;return}console.log("✅ Magic Link reenviado exitosamente"),R()}catch(t){console.error("💥 Error al reenviar:",t),a.value=t.message||"Error al reenviar el enlace"}finally{i.value=!1}}},R=()=>{w.value=!0,k.value=60;const t=ce(()=>{k.value--,k.value<=0&&(w.value=!1,clearInterval(t))},1e3)},F=()=>{g.value=!1,r.email="",r.password="",a.value="",h.value=!1},S=t=>{n.value=t,a.value="",g.value=!1,r.password="",t==="password"?r.email="info@be-mindpower.net":r.email=""};L(()=>r.email,t=>{C.value=I(t),C.value&&n.value==="magic-link"&&console.log("👑 Email de super usuario detectado")});const H=async()=>{if(!i.value){i.value=!0,a.value="";try{console.log("🔧 Registro manual de super usuario...");const t=await registerSuperUser();if(!t.success){a.value=`Error en registro: ${t.error}`;return}console.log("✅ Super usuario registrado manualmente");const e=a.value;a.value="",g.value=!0,r.email="info@be-mindpower.net",setTimeout(()=>{g.value=!1,a.value=e},3e3)}catch(t){console.error("💥 Error en registro manual:",t),a.value=t.message||"Error al registrar super usuario"}finally{i.value=!1}}},K=()=>{const t=te();console.log("🔧 Debug de configuración de Supabase:"),console.log("📍 SUPABASE_URL:",t.public.supabaseUrl),console.log("🔑 SUPABASE_KEY (primeros 20):",t.public.supabaseKey?.substring(0,20)+"..."),console.log("🌐 Current Origin:",window.location.origin),console.log("🔗 Expected Callback:",`${window.location.origin}/auth/callback`);const e=A();console.log("✅ Config Verification:",e)},W=()=>{typeof window<"u"&&window.addEventListener("supabase-auth-change",t=>{console.log("🎉 Evento de auth recibido:",t.detail);const{user:e}=t.detail;e&&(console.log("🚀 Redirigiendo por evento personalizado..."),E("/dashboard",{replace:!0}))})};return X(async()=>{try{W(),K(),console.log("🚀 Página de login inicializada")}catch(t){console.error("Error inicializando página:",t)}}),Z({title:"Acceso - Mailer Be-Mindpower",description:"Accede con Magic Link o como Super Usuario a Mailer Be-Mindpower"}),(t,e)=>{const d=Y;return l(),u("div",ue,[o("div",me,[o("div",pe,[o("div",ge,[s(n)==="magic-link"?(l(),_(s($),{key:0,class:"h-6 w-6 text-blue-600"})):(l(),_(s(y),{key:1,class:"h-6 w-6 text-blue-600"}))]),o("h2",fe,f(s(n)==="magic-link"?"Acceso con Magic Link":"Acceso de Super Usuario"),1),o("p",ve,f(s(n)==="magic-link"?"Te enviaremos un enlace seguro a tu email para acceder sin contraseña":"Acceso directo para administradores con credenciales"),1)]),o("div",be,[o("button",{onClick:e[0]||(e[0]=c=>S("magic-link")),class:T(["flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors",s(n)==="magic-link"?"bg-white text-blue-600 shadow-sm":"text-gray-500 hover:text-gray-700"])},[v(s($),{class:"h-4 w-4 inline mr-1"}),e[6]||(e[6]=b(" Magic Link ",-1))],2),o("button",{onClick:e[1]||(e[1]=c=>S("password")),class:T(["flex-1 py-2 px-4 text-sm font-medium rounded-md transition-colors",s(n)==="password"?"bg-white text-blue-600 shadow-sm":"text-gray-500 hover:text-gray-700"])},[v(s(y),{class:"h-4 w-4 inline mr-1"}),e[7]||(e[7]=b(" Super Usuario ",-1))],2)]),s(g)?(l(),u("div",xe,[o("div",we,[v(s(ie),{class:"h-5 w-5 text-green-400"}),o("div",ye,[e[10]||(e[10]=o("h3",{class:"text-sm font-medium text-green-800"}," ¡Enlace enviado! ",-1)),o("div",he,[o("p",null,[e[8]||(e[8]=b(" Hemos enviado un enlace mágico a ",-1)),o("strong",null,f(s(r).email),1),e[9]||(e[9]=b(". Revisa tu bandeja de entrada y haz clic en el enlace para acceder. ",-1))])]),o("div",ke,[o("div",_e,[o("button",{onClick:F,class:"bg-green-50 px-2 py-1.5 rounded-md text-sm font-medium text-green-800 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-green-50 focus:ring-green-600"}," Enviar a otro email "),o("button",{onClick:O,disabled:s(i)||s(w),class:"ml-3 bg-green-50 px-2 py-1.5 rounded-md text-sm font-medium text-green-800 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-green-50 focus:ring-green-600 disabled:opacity-50"},f(s(w)?`Reenviar en ${s(k)}s`:"Reenviar enlace"),9,Ee)])])])])])):p("",!0),s(a)?(l(),u("div",Ce,[o("div",Se,[v(s(le),{class:"h-5 w-5 text-red-400"}),o("div",Ue,[e[11]||(e[11]=o("h3",{class:"text-sm font-medium text-red-800"}," Error de autenticación ",-1)),o("div",Ae,[o("p",null,f(s(a)),1)])])])])):p("",!0),s(g)?p("",!0):(l(),u("form",{key:2,class:"mt-8 space-y-6",onSubmit:ee(D,["prevent"])},[o("div",null,[e[13]||(e[13]=o("label",{for:"email",class:"block text-sm font-medium text-gray-700"}," Dirección de email ",-1)),o("div",Me,[V(o("input",{id:"email","onUpdate:modelValue":e[2]||(e[2]=c=>s(r).email=c),name:"email",type:"email",autocomplete:"email",required:"",disabled:s(i)||s(n)==="password",class:"appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:s(n)==="password"?"info@be-mindpower.net":"tu@email.com"},null,8,Re),[[z,s(r).email]]),s(i)?(l(),u("div",Le,[...e[12]||(e[12]=[o("div",{class:"animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"},null,-1)])])):p("",!0)])]),s(n)==="password"?(l(),u("div",Te,[e[14]||(e[14]=o("label",{for:"password",class:"block text-sm font-medium text-gray-700"}," Contraseña de Super Usuario ",-1)),o("div",Ve,[V(o("input",{id:"password","onUpdate:modelValue":e[3]||(e[3]=c=>s(r).password=c),name:"password",type:"password",autocomplete:"current-password",required:"",disabled:s(i),class:"appearance-none block w-full px-3 py-2 border border-gray-300 rounded-md placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm disabled:bg-gray-100 disabled:cursor-not-allowed",placeholder:"Ingresa la contraseña de administrador"},null,8,ze),[[z,s(r).password]])])])):p("",!0),s(C)&&s(n)==="magic-link"?(l(),u("div",$e,[o("div",je,[v(s(y),{class:"h-5 w-5 text-blue-400"}),o("div",Ne,[e[15]||(e[15]=o("h3",{class:"text-sm font-medium text-blue-800"}," 👑 Super Usuario Detectado ",-1)),e[16]||(e[16]=o("div",{class:"mt-2 text-sm text-blue-700"},[o("p",null,"Este email pertenece a un super usuario. ¿Prefieres acceder con contraseña?")],-1)),o("div",Be,[o("button",{onClick:e[4]||(e[4]=c=>S("password")),type:"button",class:"text-sm font-medium text-blue-600 hover:text-blue-500"}," Cambiar a acceso con contraseña → ")])])])])):p("",!0),o("div",null,[o("button",{type:"submit",disabled:!s(r).email||s(i)||s(n)==="password"&&!s(r).password,class:"group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"},[s(i)?(l(),u("span",qe,[...e[17]||(e[17]=[o("div",{class:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"},null,-1)])])):p("",!0),s(n)==="magic-link"?(l(),_(s(de),{key:1,class:"h-4 w-4 mr-2"})):(l(),_(s(y),{key:2,class:"h-4 w-4 mr-2"})),b(" "+f(s(i)?s(n)==="magic-link"?"Enviando enlace...":"Autenticando...":s(n)==="magic-link"?"Enviar Magic Link":"Acceder como Super Usuario"),1)],8,Pe)]),o("div",Ie,[o("div",De,[v(s(y),{class:"h-4 w-4"}),o("span",null,f(s(n)==="magic-link"?"Acceso seguro sin contraseñas":"Acceso administrativo seguro"),1)])])],32)),o("div",Oe,[e[22]||(e[22]=oe('<div class="relative"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-50 text-gray-500">¿Necesitas ayuda?</span></div></div>',1)),o("div",Fe,[o("p",He,[e[18]||(e[18]=b(" ¿No recibes el email? ",-1)),o("button",{onClick:e[5]||(e[5]=c=>h.value=!s(h)),class:"font-medium text-blue-600 hover:text-blue-500"}," Ver consejos ")]),s(h)?(l(),u("div",Ke,[...e[19]||(e[19]=[o("ul",{class:"space-y-1"},[o("li",null,"• Revisa tu carpeta de spam o correo no deseado"),o("li",null,"• Asegúrate de que el email esté escrito correctamente"),o("li",null,"• El enlace puede tardar unos minutos en llegar"),o("li",null,"• Verifica que tu proveedor de email no bloquee emails automáticos")],-1)])])):p("",!0),o("div",We,[e[21]||(e[21]=o("p",{class:"text-xs text-gray-500 mb-2"},"¿Problemas con el super usuario?",-1)),o("div",Ye,[o("button",{onClick:H,disabled:s(i),class:"text-xs font-medium text-purple-600 hover:text-purple-500 disabled:opacity-50"}," Crear Super Usuario ",8,Ge),v(d,{to:"/auth/register-admin",class:"text-xs font-medium text-purple-600 hover:text-purple-500"},{default:se(()=>[...e[20]||(e[20]=[b(" Página de Registro ",-1)])]),_:1})])])])])])])}}});export{no as default};
