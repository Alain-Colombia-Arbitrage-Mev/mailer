import{a2 as _,r as l,E as d,a0 as i,n as C}from"#entry";const h="https://hxmdzhkkuhsetqucbpia.supabase.co",E="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh4bWR6aGtrdWhzZXRxdWNicGlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4Mzk5MjEsImV4cCI6MjA2NDQxNTkyMX0.-vUT8oRIKl4Pk7UZDOVhxxMRCictahFwAFEYc98HwFI",x=()=>{const v="info@be-mindpower.net",n=_(h,E,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}}),s=l(null),u=l(null);console.log("🔧 URLs de Supabase:"),console.log("📍 Cliente correcto:",h),n.auth.getSession().then(({data:{session:t}})=>{u.value=t,s.value=t?.user||null,console.log("📍 Usuario inicial cliente correcto:",s.value?.email||"No hay usuario")}),n.auth.onAuthStateChange((t,e)=>{if(console.log("🔄 Auth state cambió:",t,e?.user?.email),u.value=e,s.value=e?.user||null,e?.user){const a={user:{id:e.user.id,email:e.user.email,name:e.user.user_metadata?.full_name||e.user.email,isAdmin:e.user.email==="info@be-mindpower.net"},session:e,timestamp:Date.now(),isAuthenticated:!0};localStorage.setItem("admin_session",JSON.stringify(a)),localStorage.setItem("auth_status","authenticated")}else localStorage.removeItem("admin_session"),localStorage.removeItem("auth_status")});const c=l(!1),r=l(null),S=async t=>{c.value=!0,r.value=null;try{console.log("📧 Enviando Magic Link con cliente correcto a:",t);const{data:e,error:a}=await n.auth.signInWithOtp({email:t,options:{emailRedirectTo:"http://localhost:3001/auth/callback"}});return a?(console.error("❌ Error con cliente correcto:",a),r.value=a.message,{success:!1,error:a.message}):(console.log("✅ Magic Link enviado con cliente correcto"),{success:!0,message:"Magic Link enviado. Revisa tu email."})}catch(e){return console.error("💥 Error en Magic Link:",e),r.value=e.message,{success:!1,error:e.message}}finally{c.value=!1}},f=async(t,e)=>{c.value=!0,r.value=null;try{console.log("🔐 Login con cliente correcto para:",t);const{data:a,error:m}=await n.auth.signInWithPassword({email:t,password:e});if(a.user&&!m){console.log("✅ Login exitoso con cliente correcto");{const g={user:{id:a.user.id,email:a.user.email,name:"Administrador",isAdmin:!0},session:a.session,timestamp:Date.now(),isAuthenticated:!0};localStorage.setItem("admin_session",JSON.stringify(g)),localStorage.setItem("auth_status","authenticated")}return{success:!0,user:a.user,source:"supabase-correct"}}console.log("⚠️ Cliente correcto falló, probando sistema legacy...");const o=await $fetch("/api/auth/admin-login",{method:"POST",body:{email:t,password:e}});if(!o.success)return r.value=o.error||"Credenciales inválidas",{success:!1,error:o.error};{const g={user:o.user,session:o.session,timestamp:Date.now(),isAuthenticated:!0};localStorage.setItem("admin_session",JSON.stringify(g)),localStorage.setItem("auth_status","authenticated")}return console.log("✅ Login exitoso con sistema legacy"),{success:!0,user:o.user,source:"legacy"}}catch(a){return console.error("💥 Error en login con cliente correcto:",a),r.value=a.message,{success:!1,error:a.message}}finally{c.value=!1}},I=d(()=>{const t=!!s.value;let e=!1;{const m=localStorage.getItem("auth_status"),o=localStorage.getItem("admin_session");e=m==="authenticated"&&!!o}const a=t||e;return console.log("🔍 isAuthenticated check:",{hasSupabaseUser:t,hasLocalStorage:e,result:a,userEmail:s.value?.email}),a}),p=d(()=>s.value?{id:s.value.id,email:s.value.email,name:s.value.user_metadata?.full_name||s.value.email,isAdmin:s.value.email===v,source:"supabase-correct"}:null),y=async()=>{c.value=!0;try{console.log("🚪 Cerrando sesión...");try{await n.auth.signOut(),console.log("✅ Sesión cerrada en cliente correcto")}catch(t){console.warn("⚠️ Error cerrando sesión en cliente correcto:",t)}try{await nuxtSupabaseClient.auth.signOut(),console.log("✅ Sesión cerrada en cliente Nuxt")}catch(t){console.warn("⚠️ Error cerrando sesión en cliente Nuxt:",t)}return localStorage.removeItem("admin_session"),localStorage.removeItem("auth_status"),localStorage.removeItem("user_email"),localStorage.removeItem("user_role"),console.log("✅ Sesión cerrada completamente"),await C("/login"),{success:!0}}catch(t){return r.value=t.message,{success:!1,error:t.message}}finally{c.value=!1}},b=async()=>{try{console.log("🧪 Probando conexión con cliente correcto...");const{data:t,error:e}=await n.from("mailing_contacts").select("count").limit(1);return e?(console.error("❌ Error con cliente correcto:",e),{success:!1,error:e.message,message:"Conexión fallida con cliente correcto"}):(console.log("✅ Conexión exitosa con cliente correcto"),{success:!0,message:"Conexión exitosa con cliente correcto"})}catch(t){return console.error("💥 Error probando conexión:",t),{success:!1,error:t.message}}};return{isAuthenticated:I,currentUser:p,isLoading:i(c),error:i(r),supabaseUser:i(s),supabaseSession:i(u),signInWithMagicLink:S,signInWithPassword:f,signOut:y,testConnection:b,correctSupabaseClient:n}};export{x as u};
